<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stellar Echoes</title>
    <style>
        :root {
            --gradient-cosmic: linear-gradient(135deg, hsl(220, 55%, 5%) 0%, hsl(260, 40%, 10%) 50%, hsl(220, 55%, 5%) 100%);
            --gradient-nebula: radial-gradient(ellipse at center, hsla(281, 51%, 10%, 0.3) 0%, transparent 70%);
            --gradient-star-glow: radial-gradient(circle, hsl(51, 100%, 50%, 0.8) 0%, transparent 70%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--gradient-cosmic);
            color: #e8f4f8;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            background: var(--gradient-nebula);
            pointer-events: none;
            z-index: 0;
        }

        #container {
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 1;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
        }

        /* UI Overlay */
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* Welcome Screen */
        #welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 23, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: all;
            z-index: 100;
            transition: opacity 0.5s ease;
        }

        #welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .welcome-content {
            text-align: center;
            padding: 20px;
            max-width: 90%;
        }

        .welcome-content h1 {
            font-size: clamp(2rem, 8vw, 4rem);
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .welcome-content p {
            font-size: clamp(1rem, 4vw, 1.5rem);
            color: #e8f4f8;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        #start-button {
            padding: 15px 40px;
            font-size: clamp(1rem, 3vw, 1.2rem);
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #0a0e17;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }

        #start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }

        /* Instructions */
        #instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 14, 23, 0.8);
            padding: 15px 25px;
            border-radius: 15px;
            pointer-events: all;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            max-width: 90%;
        }

        #instructions p {
            font-size: clamp(0.8rem, 2vw, 1rem);
            text-align: center;
            margin: 5px 0;
        }

        /* Photo Modal */
        #photo-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 23, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            pointer-events: all;
            z-index: 50;
        }

        #photo-modal.active {
            display: flex;
        }

        #photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.5);
        }

        #close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #ffd700;
            border-radius: 50%;
            color: #ffd700;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }

        #close-modal:hover {
            background: rgba(255, 215, 0, 0.4);
            transform: scale(1.1);
        }

        /* Loading Indicator */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: #ffd700;
            z-index: 5;
        }

        .spinner {
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-top: 3px solid #ffd700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #blessing-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 23, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            pointer-events: all;
            z-index: 50;
        }

        #blessing-modal.active {
            display: flex;
        }

        .blessing-content {
            background: rgba(20, 25, 40, 0.9);
            border-radius: 20px;
            padding: 40px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .blessing-content h2 {
            color: #ffd700;
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .blessing-text {
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 30px;
            text-align: left;
            color: #e8f4f8;
        }

        .blessing-text p {
            margin-bottom: 20px;
        }

        .signature {
            text-align: right;
            font-style: italic;
            color: #ffd700;
            font-size: 1.3rem;
            margin-top: 30px;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="canvas-container"></div>

        <!-- UI Overlay -->
        <div id="ui-overlay">
            <!-- Welcome Screen -->
            <div id="welcome-screen">
                <div class="welcome-content">
                    <h1>Stellar Echoes</h1>
                    <p>Each star holds a memory,<br>each flicker tells a story.</p>
                    <p style="font-size: clamp(0.9rem, 3vw, 1.2rem); color: #ffd700; margin-top: 20px;">
                        Look for the stars that speak in code
                    </p>
                    <button id="start-button">Begin Journey</button>
                </div>
            </div>

            <!-- Instructions -->
            <div id="instructions">
                <p>Swipe to rotate • Pinch to zoom • Tap stars to view</p>
            </div>

            <!-- Loading -->
            <div id="loading" style="display: none;">
                <div class="spinner"></div>
                <div>Loading...</div>
            </div>
        </div>

        <!-- Control Panel -->
        <div id="control-panel" style="position: absolute; top: 20px; right: 20px; pointer-events: all; z-index: 20;">
            <button id="blessing-button" class="control-button"
                style="width: 50px; height: 50px; background: rgba(10, 14, 23, 0.8); border: 2px solid #ffd700; border-radius: 50%; color: #ffd700; font-size: 20px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.3s ease; backdrop-filter: blur(10px);">
            </button>
        </div>

        <!-- Photo Modal -->
        <div id="photo-modal">
            <button id="close-modal">×</button>
            <img id="modal-image" src="" alt="Memory">
        </div>

        <div id="blessing-modal">
            <button id="close-blessing" class="control-button"
                style="position: absolute; top: 20px; right: 20px;">×</button>
            <div class="blessing-content">
                <h2>生日快乐！</h2>
                <div class="blessing-text">
                    <p>很高兴我们持续多年的友谊持续不断。</p>
                    <p>愿你每天都开心快乐，愿你的梦想都能实现。</p>
                    <p>我们的回忆如星光点点滴滴，忆回都是忽闪忽暗。</p>
                    <p>即使相隔遥远，也依然记得彼此。</p>
                    <p>生日快乐！我们的友谊长存！</p>
                </div>
                <div class="signature">
                    —— 你的朋友 民宇
                </div>
            </div>
        </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            photos: [
                // Add your photo URLs here - as many as you want!
                './src/assets/images/image1.jpg',
                './src/assets/images/image2.jpg',
                './src/assets/images/image3.jpg',
                './src/assets/images/image4.jpg',
                './src/assets/images/image5.jpg',
                './src/assets/images/image6.jpg',
                './src/assets/images/image7.jpg',
                './src/assets/images/image8.jpg',
            ],
            morseMessage: 'HAPPY BIRTHDAY',
            colors: {
                space: 0x0a0e17,
                starlight: 0xe8f4f8,
                accent: 0xffd700
            }
        };

        // Morse code dictionary
        const MORSE_CODE = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
            'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
            'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
            'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..', ' ': '/'
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            scene: null,
            camera: null,
            renderer: null,
            particles: [],
            morseParticles: [],
            backgroundStars: null,
            audio: null,
            isPlaying: false,
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            morseIndex: 0,
            morseTime: 0,
            autoRotationSpeed: 0.0002
        };

        // ============================================
        // MORSE CODE CONVERTER
        // ============================================
        function textToMorse(text) {
            return text.toUpperCase().split('').map(char => MORSE_CODE[char] || '').join(' ');
        }

        function morseToTiming(morse) {
            const timings = [];
            const dotDuration = 200; // ms
            const dashDuration = 600;
            const gapDuration = 200;
            const letterGap = 600;
            const wordGap = 1400;

            for (let i = 0; i < morse.length; i++) {
                const char = morse[i];
                if (char === '.') {
                    timings.push({ type: 'on', duration: dotDuration });
                    timings.push({ type: 'off', duration: gapDuration });
                } else if (char === '-') {
                    timings.push({ type: 'on', duration: dashDuration });
                    timings.push({ type: 'off', duration: gapDuration });
                } else if (char === ' ') {
                    timings.push({ type: 'off', duration: letterGap });
                } else if (char === '/') {
                    timings.push({ type: 'off', duration: wordGap });
                }
            }
            return timings;
        }

        // ============================================
        // THREE.JS SETUP
        // ============================================
        function initThreeJS() {
            const container = document.getElementById('canvas-container');

            // Scene
            state.scene = new THREE.Scene();
            // Make scene background transparent to show CSS gradient
            state.scene.background = null;
            state.scene.fog = new THREE.FogExp2(0x0a0e17, 0.0008);

            // Camera
            const aspect = window.innerWidth / window.innerHeight;
            state.camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 2000);
            state.camera.position.z = state.isMobile ? 150 : 120;

            // Renderer
            state.renderer = new THREE.WebGLRenderer({
                antialias: !state.isMobile,
                powerPreference: 'high-performance',
                alpha: true // Enable transparency to show CSS background
            });
            state.renderer.setSize(window.innerWidth, window.innerHeight);
            state.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(state.renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            state.scene.add(ambientLight);

            const pointLight = new THREE.PointLight(CONFIG.colors.accent, 1, 500);
            pointLight.position.set(0, 0, 0);
            state.scene.add(pointLight);

            // Add background stars
            addBackgroundStars();
        }

        // ============================================
        // BACKGROUND STARS
        // ============================================
        function addBackgroundStars() {
            const starCount = state.isMobile ? 500 : 1000;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(starCount * 3);

            for (let i = 0; i < starCount * 3; i += 3) {
                positions[i] = (Math.random() - 0.5) * 1000;
                positions[i + 1] = (Math.random() - 0.5) * 1000;
                positions[i + 2] = (Math.random() - 0.5) * 1000;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

            const material = new THREE.PointsMaterial({
                color: CONFIG.colors.starlight,
                size: state.isMobile ? 1 : 2,
                transparent: true,
                opacity: 0.6
            });

            const stars = new THREE.Points(geometry, material);
            state.scene.add(stars);
            state.backgroundStars = stars; // Store reference for rotation
        }

        // ============================================
        // PHOTO PARTICLES
        // ============================================
        function createPhotoParticles() {
            const textureLoader = new THREE.TextureLoader();
            const particleCount = CONFIG.photos.length;

            // Create sphere distribution
            const radius = 80;

            CONFIG.photos.forEach((photoUrl, index) => {
                // Spherical distribution
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);

                const x = radius * Math.sin(phi) * Math.cos(theta);
                const y = radius * Math.sin(phi) * Math.sin(theta);
                const z = radius * Math.cos(phi);

                // Create sprite
                const canvas = document.createElement('canvas');
                canvas.width = 64;
                canvas.height = 64;
                const ctx = canvas.getContext('2d');

                // Draw glow effect with gradient
                const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
                gradient.addColorStop(0, 'hsla(51, 100%, 50%, 1)');
                gradient.addColorStop(0.4, 'hsla(51, 100%, 50%, 0.6)');
                gradient.addColorStop(1, 'hsla(51, 100%, 50%, 0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 64, 64);

                const texture = new THREE.CanvasTexture(canvas);

                const material = new THREE.SpriteMaterial({
                    map: texture,
                    transparent: true,
                    opacity: 0.8,
                    blending: THREE.AdditiveBlending
                });

                const sprite = new THREE.Sprite(material);
                sprite.position.set(x, y, z);
                sprite.scale.set(8, 8, 1);
                sprite.userData = {
                    photoUrl: photoUrl,
                    baseOpacity: 0.8,
                    flickerSpeed: Math.random() * 0.5 + 0.5,
                    isMorse: false
                };

                state.scene.add(sprite);
                state.particles.push(sprite);
            });

            // Select some particles for Morse code
            const morseCount = Math.min(5, Math.floor(particleCount * 0.3));
            const morseIndices = [];
            while (morseIndices.length < morseCount) {
                const idx = Math.floor(Math.random() * particleCount);
                if (!morseIndices.includes(idx)) {
                    morseIndices.push(idx);
                    state.particles[idx].userData.isMorse = true;
                    state.morseParticles.push(state.particles[idx]);
                }
            }
        }

        // ============================================
        // INTERACTION CONTROLS
        // ============================================
        function setupControls() {
            const canvas = state.renderer.domElement;
            let isDragging = false;
            let previousTouch = { x: 0, y: 0 };
            let rotationVelocity = { x: 0, y: 0 };

            // Mouse/Touch handlers
            function onPointerDown(e) {
                isDragging = true;
                const coords = e.touches ? e.touches[0] : e;
                previousTouch = { x: coords.clientX, y: coords.clientY };
                rotationVelocity = { x: 0, y: 0 };
            }

            function onPointerMove(e) {
                if (!isDragging) return;
                const coords = e.touches ? e.touches[0] : e;

                const deltaX = coords.clientX - previousTouch.x;
                const deltaY = coords.clientY - previousTouch.y;

                rotationVelocity.x = deltaY * 0.005;
                rotationVelocity.y = deltaX * 0.005;

                previousTouch = { x: coords.clientX, y: coords.clientY };
            }

            function onPointerUp() {
                isDragging = false;
            }

            function onWheel(e) {
                e.preventDefault();
                state.camera.position.z += e.deltaY * 0.05;
                state.camera.position.z = Math.max(50, Math.min(300, state.camera.position.z));
            }

            // Pinch zoom for mobile
            let lastDistance = 0;
            function onTouchMove(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (lastDistance > 0) {
                        const delta = distance - lastDistance;
                        state.camera.position.z -= delta * 0.3;
                        state.camera.position.z = Math.max(50, Math.min(300, state.camera.position.z));
                    }
                    lastDistance = distance;
                } else {
                    onPointerMove(e);
                }
            }

            function onTouchEnd(e) {
                if (e.touches.length < 2) lastDistance = 0;
                if (e.touches.length === 0) onPointerUp();
            }

            // Click to view photo
            function onClick(e) {
                if (isDragging) return;

                const coords = e.touches ? e.changedTouches[0] : e;
                const mouse = new THREE.Vector2(
                    (coords.clientX / window.innerWidth) * 2 - 1,
                    -(coords.clientY / window.innerHeight) * 2 + 1
                );

                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, state.camera);

                const intersects = raycaster.intersectObjects(state.particles);
                if (intersects.length > 0) {
                    const particle = intersects[0].object;
                    showPhotoModal(particle.userData.photoUrl);
                }
            }

            // Event listeners
            canvas.addEventListener('mousedown', onPointerDown);
            canvas.addEventListener('mousemove', onPointerMove);
            canvas.addEventListener('mouseup', onPointerUp);
            canvas.addEventListener('wheel', onWheel, { passive: false });

            canvas.addEventListener('touchstart', onPointerDown);
            canvas.addEventListener('touchmove', onTouchMove, { passive: false });
            canvas.addEventListener('touchend', onTouchEnd);

            canvas.addEventListener('click', onClick);
            canvas.addEventListener('touchend', onClick);

            // Auto-rotation with damping
            function updateRotation() {
                if (!isDragging) {
                    rotationVelocity.x *= 0.95;
                    rotationVelocity.y *= 0.95;
                }

                const autoRotation = isDragging ? 0 : state.autoRotationSpeed;

                // Rotate photo particles
                state.particles.forEach(particle => {
                    particle.position.applyAxisAngle(new THREE.Vector3(1, 0, 0), rotationVelocity.x);
                    particle.position.applyAxisAngle(new THREE.Vector3(0, 1, 0), rotationVelocity.y + autoRotation);
                });

                // Rotate background stars too
                if (state.backgroundStars) {
                    state.backgroundStars.rotation.x += rotationVelocity.x;
                    state.backgroundStars.rotation.y += rotationVelocity.y + autoRotation;
                }

                requestAnimationFrame(updateRotation);
            }
            updateRotation();
        }

        // ============================================
        // PHOTO MODAL
        // ============================================
        function showPhotoModal(photoUrl) {
            const modal = document.getElementById('photo-modal');
            const img = document.getElementById('modal-image');
            img.src = photoUrl;
            modal.classList.add('active');
        }

        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('photo-modal').classList.remove('active');
        });

        document.getElementById('photo-modal').addEventListener('click', (e) => {
            if (e.target.id === 'photo-modal') {
                document.getElementById('photo-modal').classList.remove('active');
            }
        });

        // ============================================
        // BLESSING MODAL
        // ============================================
        function showBlessingModal() {
            document.getElementById('blessing-modal').classList.add('active');
        }

        document.getElementById('blessing-button').addEventListener('click', showBlessingModal);

        document.getElementById('close-blessing').addEventListener('click', () => {
            document.getElementById('blessing-modal').classList.remove('active');
        });

        document.getElementById('blessing-modal').addEventListener('click', (e) => {
            if (e.target.id === 'blessing-modal') {
                document.getElementById('blessing-modal').classList.remove('active');
            }
        });

        // ============================================
        // MORSE CODE ANIMATION
        // ============================================
        const morseTimings = morseToTiming(textToMorse(CONFIG.morseMessage) + ' ' + textToMorse(CONFIG.morseMessage)); // Loop message
        let currentMorseState = 'off';
        let morseTimer = 0;
        let currentTimingIndex = 0;

        function updateMorseCode(deltaTime) {
            morseTimer += deltaTime * 1000; // Convert to ms

            if (currentTimingIndex >= morseTimings.length) {
                currentTimingIndex = 0;
                morseTimer = 0;
            }

            const currentTiming = morseTimings[currentTimingIndex];

            if (morseTimer >= currentTiming.duration) {
                morseTimer = 0;
                currentTimingIndex++;
                currentMorseState = currentTiming.type;
            }

            // Apply morse state to designated particles
            state.morseParticles.forEach(particle => {
                if (currentMorseState === 'on') {
                    particle.material.opacity = 1.0;
                    particle.scale.set(10, 10, 1);
                } else {
                    particle.material.opacity = 0.3;
                    particle.scale.set(8, 8, 1);
                }
            });
        }

        // ============================================
        // ANIMATION LOOP
        // ============================================
        let lastTime = 0;
        function animate(time) {
            requestAnimationFrame(animate);

            const deltaTime = (time - lastTime) / 1000;
            lastTime = time;

            // Update morse code
            updateMorseCode(deltaTime);

            // Flicker non-morse particles
            state.particles.forEach(particle => {
                if (!particle.userData.isMorse) {
                    const flicker = Math.sin(time * 0.001 * particle.userData.flickerSpeed) * 0.2 + 0.8;
                    particle.material.opacity = particle.userData.baseOpacity * flicker;
                }
            });

            // Render
            state.renderer.render(state.scene, state.camera);
        }

        // ============================================
        // WINDOW RESIZE
        // ============================================
        window.addEventListener('resize', () => {
            state.camera.aspect = window.innerWidth / window.innerHeight;
            state.camera.updateProjectionMatrix();
            state.renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        document.getElementById('start-button').addEventListener('click', () => {
            document.getElementById('welcome-screen').classList.add('hidden');
        });

        // Initialize everything
        window.addEventListener('load', () => {
            initThreeJS();
            createPhotoParticles();
            setupControls();
            animate(0);
        });
    </script>
</body>

</html>